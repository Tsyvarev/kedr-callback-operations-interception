<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>6. Create interceptors using template-based file generation</title><link rel="stylesheet" href="kedr-coi-doc.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.75.2"><link rel="home" href="index.html" title="KEDR COI 0.1 Reference Manual"><link rel="up" href="index.html" title="KEDR COI 0.1 Reference Manual"><link rel="prev" href="pre_existed_interceptors.html" title="5. Interceptors already implemented in KEDR COI"><link rel="next" href="api_reference.html" title="7. API Reference"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">6. Create interceptors using template-based file generation</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="pre_existed_interceptors.html">Prev</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="api_reference.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="create_interceptors_using_kedr_gen"></a>6. Create interceptors using template-based file generation</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="create_interceptors_using_kedr_gen.html#create_interceptors_using_kedr_gen.output">6.1. Files generated for interceptor</a></span></dt><dt><span class="section"><a href="create_interceptors_using_kedr_gen.html#create_interceptors_using_kedr_gen.interceptor_parameters">6.2. Definition file for interceptor</a></span></dt><dt><span class="section"><a href="create_interceptors_using_kedr_gen.html#create_interceptors_using_kedr_gen.foreign_output">6.3. Files generated for foreign interceptor</a></span></dt><dt><span class="section"><a href="create_interceptors_using_kedr_gen.html#create_interceptors_using_kedr_gen.foreign_interceptor_parameters">6.4. Definition file for foreign interceptor</a></span></dt></dl></div><p>
Though the logic of intermediate operations used for interceptor creation is not complex(see <a class="xref" href="using_kedr_coi.html#interceptor_creation.intermediate_operations">Section 4.4.2, “Intermediate operations”</a>), writing code for that operations by hands is not an easy task. The main reason of this is the lack of typecheking inside the KEDR COI library.
</p><p>
Because the library is intended to use for any objects and callback operations, many essences have very abstract types and definitions. E.g, objects have type '<span class="type">void*</span>', callback operations identifies by there offsets in the object or operations struct, pointers to callback operations have type '<span class="type">void*</span>', same for pre- and post-handlers signatures, etc.
</p><p>
But intermediate operation should call interception handlers and original callback operation, so it should actively use typecasts, which make compiler unable to detect incorrectly used types of variables and functions. So, many possible human errors in intermediate operations aren't revealed at the compile phase. Moreover, some of these errors may be revealed at runtime only after a long time of using.
</p><p>
From the other side, a little information is needed for create intermediate operations for particular object type. And this information may be expressed in the terms of concrete types and names - type of the object, names of the callback operations, types and names of their arguments, etc - which is much less error-prone than writing code of intermediate operations. For create code of intermediate operations from such information template-base generator may be used.
</p><p>
KEDR COI has templates suitable for create interceptors using 'kedr_gen' generator. The only thing which should be provided by the user is a 'definition' file contained some information about object's type and its operations. Generator itself and format of definition files are fully described in the documentation of KEDR project (<a class="ulink" href="http://kedr.berlios.de/kedr-doc/extend.html#using_gen" target="_top">http://kedr.berlios.de/kedr-doc/extend.html#using_gen</a>). Templates are placed in the directory <code class="filename">/usr/local/share/kedr-coi/tepmplates</code>.
</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="create_interceptors_using_kedr_gen.output"></a>6.1. Files generated for interceptor</h3></div></div></div><p>
Using template <code class="filename">kedr_coi_interceptor.h</code> one can create header file for interceptor. This file contains definitions in same format as for predefined interceptors (see <a class="xref" href="pre_existed_interceptors.html#pre_existed_interceptors.interceptor_api">Section 5.1, “Object type-specific interceptor's API”</a>). For create source file with interceptor's implementation, template <code class="filename">kedr_coi_interceptor.c</code> should be used.
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="create_interceptors_using_kedr_gen.interceptor_parameters"></a>6.2. Definition file for interceptor</h3></div></div></div><p>
Definition file for interceptor should contain definitions for the following parameters:
</p><div class="variablelist"><dl><dt><span class="term">interceptor.name</span></dt><dd>Name of the interceptor, used in its constructor. This name also is used as a prefix for all exported functions and macros for this interceptor (<em class="replaceable"><code>prefix</code></em> in the functions description).</dd><dt><span class="term">interceptor.operations_prefix</span></dt><dd>String which will be used as prefix for all operations-specific definitions (<em class="replaceable"><code>opprefix</code></em> in the functions description).</dd><dt><span class="term">header</span></dt><dd>Includes and other C-code, which contains definition of types and functions used for interceptor. May be multi-valued, in that case all values are joined together.</dd><dt><span class="term">implementation_header</span></dt><dd>Additional includes and other C-code, which used in implementation of intermediate functions. May be multi-valued, in that case all values are joined together.</dd><dt><span class="term">object.type</span></dt><dd>Type of the objects for which interceptor should be applied (<em class="replaceable"><code>object_t</code></em> in the functions description).</dd><dt><span class="term">interceptor.is_direct</span></dt><dd>Empty for direct interceptor, for indirect interceptor should be empty or not defined. <a class="xref" href="using_kedr_coi.html#interceptor_creation.object_geometry">Section 4.4.1, “Object's geometry”</a> describes interceptor types. </dd><dt><span class="term">object.operations_field</span></dt><dd>Field in the object struct which is a pointer to the operations structure (only for indirect interceptor)</dd><dt><span class="term">operations.type</span></dt><dd>Type of the operations structure (only for indirect insterceptor)</dd></dl></div><p>
</p><p>
For every callback operations, interception of which should be supported, a group should be prepared in the definition file. Each group should contain definitions for the following parameters:
</p><div class="variablelist"><dl><dt><span class="term">operation.name</span></dt><dd>Name of the callback operation, as a field name in the object/operations structure</dd><dt><span class="term">operation.returnType</span></dt><dd>Type returning by this operation; if operation doesn't return value should be empty or isn't defined</dd><dt><span class="term">operation.arg.type</span></dt><dd>(multi-valued) types of the parameters of the callback operation, starting with the first one</dd><dt><span class="term">operation.arg.name</span></dt><dd>(multi-valued) names of the parameters of the callback operation, starting with the first one. Parameters will be accessible via these names in the code.</dd><dt><span class="term">operation.object</span></dt><dd>Parameter name or other c-expression returned owner object for this operation call. Names of operation's parameters and global functions and variables may be used in this expression.</dd><dt><span class="term">operation.default</span></dt><dd>Implementation of the <a class="link" href="glossary.html#default_callback_operation">default callback operation</a>. It will be executed in case when pointer to original operation is <code class="constant">NULL</code>. Names of operation's parameters and global functions and variables may be used in this code.
        <p>If this parameter is not defined or empty, intermediate for that operation is used for only internal interception (see <a class="xref" href="using_kedr_coi.html#interceptor_creation.intermediate_operations.internal_only">Section 4.4.2.1, “Intermediate operations only for internal interception”</a>).</p></dd><dt><span class="term">operation.group_id</span></dt><dd>Number identified operations group. Operations from the same group either are all replaced by intermediates or aren't replaced at all. Grouping is not used if this parameter is <code class="constant">0</code> or isn't defined. See <a class="xref" href="using_kedr_coi.html#interceptor_creation.intermediate_operations.grouping">Section 4.4.2.2, “Grouping of intermediate operations”</a> for example of using this parameter. Shouldn't be defined if 'operation.default' parameter is not defined.</dd></dl></div><p>
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="create_interceptors_using_kedr_gen.foreign_output"></a>6.3. Files generated for foreign interceptor</h3></div></div></div><p>
Using template <code class="filename">kedr_coi_foreign_interceptor.h</code> one can create header file for foreign interceptor. This file contains definitions in same format as for predefined foreign interceptors (see <a class="xref" href="pre_existed_interceptors.html#pre_existed_interceptors.foreign_interceptor_api">Section 5.2, “Object type-specific foreign interceptor's API”</a>). For create source file with foreign interceptor's implementation, template <code class="filename">kedr_coi_foreign_interceptor.c</code> should be used.
</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="create_interceptors_using_kedr_gen.foreign_interceptor_parameters"></a>6.4. Definition file for foreign interceptor</h3></div></div></div><p>
Definition file for foreign interceptor should contain definitions for the following parameters:
</p><div class="variablelist"><dl><dt><span class="term">interceptor.name</span></dt><dd>Name of the interceptor, used in its constructor. This name also is used as a prefix for all exported functions and macros for this interceptor (<em class="replaceable"><code>prefix</code></em> in the functions description).</dd><dt><span class="term">header</span></dt><dd>Includes and other C-code, which contains definition of types and functions used for interceptor. May be multi-valued, in that case all values are joined together.</dd><dt><span class="term">implementation_header</span></dt><dd>Additional includes and other C-code, which used in implementation of intermediate functions. May be multi-valued, in that case all values are joined together.</dd><dt><span class="term">prototype_object.type</span></dt><dd>Type of the prototype objects for which foreign interceptor is applied (<em class="replaceable"><code>object_t</code></em> in the functions description).</dd><dt><span class="term">prototype_object.operations_field</span></dt><dd>Field in the prototype object struct which is a pointer to the operations structure</dd><dt><span class="term">object.type</span></dt><dd>Type of the owner object to which operations belong. Binded interceptor operates with objects of this type.</dd><dt><span class="term">object.operations_field</span></dt><dd>Field in the owner object struct which is a pointer to the operations structure. (In the current templates this field is not used.)</dd><dt><span class="term">operations.type</span></dt><dd>Type of the operations structure.</dd></dl></div><p>
</p><p>
For every callback operation which is called just after new object is created a group should be prepared in the definition file. Each group should contain definitions for the following parameters:
</p><div class="variablelist"><dl><dt><span class="term">operation.name</span></dt><dd>Name of the callback operation, as a field name in the operations structure.</dd><dt><span class="term">operation.returnType</span></dt><dd>Type returning by this operation; if operation doesn't return value should be empty or isn't defined.</dd><dt><span class="term">operation.arg.type</span></dt><dd>(multi-valued) types of the parameters of the callback operation, starting with the first one</dd><dt><span class="term">operation.arg.name</span></dt><dd>(multi-valued) names of the parameters of the callback operation, starting with the first one. Parameters will be accessible via these names in the code.</dd><dt><span class="term">operation.object</span></dt><dd>Parameter name or other c-expression returned owner object for this operation call. Names of operation's parameters and global functions and variables may be used in this expression.</dd><dt><span class="term">operation.prototype_object</span></dt><dd>parameter name or other c-expression returned prototype object from wich new object is created. Names of operation's parameters and global functions and variables may be used in this expression.</dd><dt><span class="term">operation.default</span></dt><dd>Implementation of the <a class="link" href="glossary.html#default_callback_operation">default callback operation</a>. It will be executed in case when pointer to the chained operation is <code class="constant">NULL</code>. Names of operation's parameters and global functions and variables may be used in this code. It is allowed to let this parameter empty only when the callback operation may not be NULL in any case.</dd></dl></div><p>
</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="pre_existed_interceptors.html">Prev</a> </td><td width="20%" align="center"> </td><td width="40%" align="right"> <a accesskey="n" href="api_reference.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">5. Interceptors already implemented in KEDR COI </td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top"> 7. API Reference</td></tr></table></div></body></html>
